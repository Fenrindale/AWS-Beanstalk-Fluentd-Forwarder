# ===== Inputs: UDP/TCP 5140, 원 IP 주입 =====
<source>
  @type udp
  port 5140
  bind 0.0.0.0
  tag syslog.raw
  source_address_key source_ip
  <parse>
    @type none
  </parse>
</source>

<source>
  @type tcp
  port 5140
  bind 0.0.0.0
  tag syslog.raw
  source_address_key source_ip
  <parse>
    @type none
  </parse>
</source>

# ===== Tag rewrite: ESET vs Fortigate =====
<match syslog.raw>
  @type rewrite_tag_filter
  <rule>
    key source_ip
    pattern ^114\.203\.85\.179$
    tag syslog.eset
  </rule>
  <rule>
    key source_ip
    pattern .*
    tag syslog.fortigate
  </rule>
</match>

# ===== Fortigate 인코딩 변환(CP949 -> UTF-8) =====
<filter syslog.fortigate>
  @type record_modifier
  char_encoding cp949:utf-8
</filter>

# ===== Firehose 출력: IAM Role 사용(키 하드코딩 금지) =====
<match syslog.*>
  @type kinesis_firehose
  @id output_kinesis_syslog
  region ap-northeast-2
  delivery_stream_name fh-aiapp-pim-syslog
  <buffer>
    @type file
    path /var/log/fluent/buffer/kinesis
    chunk_limit_size 5m
    flush_interval 5s
    flush_thread_count 2
    retry_max_interval 60
    retry_forever true
  </buffer>
  <format>
    @type json
  </format>
</match>
